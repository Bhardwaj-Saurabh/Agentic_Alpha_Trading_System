import os
import sys
import psycopg2
from psycopg2.extras import RealDictCursor
from datetime import datetime, date

sys.path.append(os.path.dirname(os.path.dirname(__file__)))
from config import Config

class Database:
    def __init__(self):
        try:
            # Try config file first, then fallback to environment variable
            database_url = Config.DATABASE_URL if hasattr(Config, 'DATABASE_URL') else os.environ.get('DATABASE_URL', 'postgresql://localhost/trading_db')
            self.conn = psycopg2.connect(database_url)

            # Set search path to public schema for cloud databases
            with self.conn.cursor() as cur:
                cur.execute("SET search_path TO public;")
                self.conn.commit()

        except Exception as e:
            print(f"Database connection failed: {e}")
            print("Using SQLite fallback...")
            # Could add SQLite fallback here if needed
        self.create_tables()

    def create_tables(self):
        with self.conn.cursor() as cur:
            try:
                # Try to find a schema the user owns or has CREATE privileges on
                cur.execute("""
                    SELECT n.nspname
                    FROM pg_catalog.pg_namespace n
                    WHERE n.nspowner = (SELECT oid FROM pg_roles WHERE rolname = current_user)
                       OR pg_catalog.has_schema_privilege(current_user, n.nspname, 'CREATE')
                    AND n.nspname NOT IN ('pg_catalog', 'information_schema', 'pg_toast', 'pg_temp_1', 'pg_toast_temp_1')
                    ORDER BY
                        CASE
                            WHEN n.nspname = 'public' THEN 1
                            WHEN n.nspowner = (SELECT oid FROM pg_roles WHERE rolname = current_user) THEN 2
                            ELSE 3
                        END
                    LIMIT 1;
                """)
                result = cur.fetchone()

                if result:
                    schema_name = result[0]
                    print(f"Using schema: {schema_name}")
                    cur.execute(f"SET search_path TO {schema_name};")
                    self.conn.commit()
                else:
                    # Try to get current_user and create a schema with that name
                    cur.execute("SELECT current_user;")
                    username = cur.fetchone()[0]
                    try:
                        cur.execute(f"CREATE SCHEMA IF NOT EXISTS {username};")
                        cur.execute(f"SET search_path TO {username};")
                        self.conn.commit()
                        print(f"Created and using schema: {username}")
                    except:
                        # If all else fails, just proceed and hope for the best
                        print("Warning: Could not set a specific schema, using database default")

                # Keep existing sequences for signals and decisions (without schema prefix)
                cur.execute("""
                    CREATE SEQUENCE IF NOT EXISTS trading_signals_id_seq;
                    CREATE SEQUENCE IF NOT EXISTS trading_decisions_id_seq;
                """)


                cur.execute("""
                    CREATE TABLE IF NOT EXISTS trading_signals (
                        id INTEGER PRIMARY KEY DEFAULT nextval('trading_signals_id_seq'),
                        symbol VARCHAR(10) NOT NULL,
                        signal_type VARCHAR(10) NOT NULL,
                        strategy VARCHAR(50) NOT NULL,
                        confidence FLOAT NOT NULL,
                        timestamp TIMESTAMP NOT NULL
                    )
                """)

                cur.execute("""
                    CREATE TABLE IF NOT EXISTS screened_stocks (
                        id SERIAL PRIMARY KEY,
                        symbol VARCHAR(10) NOT NULL,
                        company_name VARCHAR(100),
                        current_price DECIMAL(10, 2) NOT NULL,
                        average_volume BIGINT NOT NULL,
                        last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        UNIQUE(symbol)
                    )
                """)


                # Add new table for trading decisions
                cur.execute("""
                    CREATE TABLE IF NOT EXISTS trading_decisions (
                        id SERIAL PRIMARY KEY,
                        symbol VARCHAR(10) NOT NULL,
                        decision TEXT NOT NULL,
                        confidence FLOAT NOT NULL,
                        agent_name VARCHAR(50) NOT NULL DEFAULT 'supervisor',
                        created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
                    );
                    CREATE UNIQUE INDEX IF NOT EXISTS trading_decisions_daily_idx
                    ON trading_decisions (symbol, date(created_at));
                """)

                # Add audit trail table for compliance
                cur.execute("""
                    CREATE TABLE IF NOT EXISTS audit_trail (
                        id SERIAL PRIMARY KEY,
                        symbol VARCHAR(10) NOT NULL,
                        decision_type VARCHAR(50) NOT NULL,
                        action VARCHAR(50) NOT NULL,
                        confidence FLOAT NOT NULL,
                        rationale TEXT,
                        compliance_status VARCHAR(50),
                        risk_level VARCHAR(50),
                        position_size VARCHAR(50),
                        blocked_trades TEXT,
                        timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
                    );
                    CREATE INDEX IF NOT EXISTS audit_trail_symbol_idx ON audit_trail (symbol);
                    CREATE INDEX IF NOT EXISTS audit_trail_timestamp_idx ON audit_trail (timestamp DESC);
                """)

                # MIGRATION: Fix column sizes if they're too small (automatic fix)
                try:
                    cur.execute("""
                        DO $$
                        BEGIN
                            -- Check and alter action column if it's VARCHAR(20)
                            IF EXISTS (
                                SELECT 1 FROM information_schema.columns
                                WHERE table_name = 'audit_trail'
                                AND column_name = 'action'
                                AND character_maximum_length = 20
                            ) THEN
                                ALTER TABLE audit_trail ALTER COLUMN action TYPE VARCHAR(50);
                            END IF;

                            -- Check and alter risk_level column if it's VARCHAR(20)
                            IF EXISTS (
                                SELECT 1 FROM information_schema.columns
                                WHERE table_name = 'audit_trail'
                                AND column_name = 'risk_level'
                                AND character_maximum_length = 20
                            ) THEN
                                ALTER TABLE audit_trail ALTER COLUMN risk_level TYPE VARCHAR(50);
                            END IF;
                        END $$;
                    """)
                    self.conn.commit()
                except Exception as migration_error:
                    # Migration failed, but continue - table might not exist yet
                    self.conn.rollback()
                    pass

                self.conn.commit()
            except Exception as e:
                self.conn.rollback()
                print(f"Error creating tables: {str(e)}")
                raise


    def add_signal(self, symbol, signal_type, strategy, confidence):
        with self.conn.cursor() as cur:
            cur.execute("""
                INSERT INTO trading_signals 
                (symbol, signal_type, strategy, confidence, timestamp)
                VALUES (%s, %s, %s, %s, %s)
                """, (symbol, signal_type, strategy, confidence, datetime.now()))
            self.conn.commit()

    def upsert_screened_stock(self, symbol, company_name, current_price, average_volume):
        with self.conn.cursor() as cur:
            cur.execute("""
                INSERT INTO screened_stocks 
                (symbol, company_name, current_price, average_volume, last_updated)
                VALUES (%s, %s, %s, %s, %s)
                ON CONFLICT (symbol) 
                DO UPDATE SET 
                    company_name = EXCLUDED.company_name,
                    current_price = EXCLUDED.current_price,
                    average_volume = EXCLUDED.average_volume,
                    last_updated = EXCLUDED.last_updated
                """, (symbol, company_name, current_price, average_volume, datetime.now()))
            self.conn.commit()

    def get_screened_stocks(self):
        with self.conn.cursor(cursor_factory=RealDictCursor) as cur:
            cur.execute("""
                SELECT * FROM screened_stocks 
                ORDER BY symbol ASC
                """)
            return cur.fetchall()

    def clear_old_screened_stocks(self, hours=24):
        with self.conn.cursor() as cur:
            cur.execute("""
                DELETE FROM screened_stocks 
                WHERE last_updated < NOW() - INTERVAL '%s hours'
                """, (hours,))
            self.conn.commit()

    def save_trading_decision(self, symbol: str, decision: str, confidence: float, agent_name: str = 'supervisor'):
        """Save a new trading decision for a stock"""
        try:
            with self.conn.cursor() as cur:
                cur.execute("""
                    INSERT INTO trading_decisions (symbol, decision, confidence, agent_name)
                    VALUES (%s, %s, %s, %s)
                    """, (symbol, decision, confidence, agent_name))
                self.conn.commit()
        except Exception as e:
            print(f"Database connection error in save_trading_decision: {str(e)}")
            # Try to reconnect
            try:
                import os
                self.conn = psycopg2.connect(os.environ['DATABASE_URL'])
                with self.conn.cursor() as cur:
                    cur.execute("""
                        INSERT INTO trading_decisions (symbol, decision, confidence, agent_name)
                        VALUES (%s, %s, %s, %s)
                        """, (symbol, decision, confidence, agent_name))
                    self.conn.commit()
                print("Database reconnection successful")
            except Exception as reconnect_error:
                print(f"Database reconnection failed: {str(reconnect_error)}")
                raise

    def get_latest_trading_decisions(self, symbol: str, limit: int = 2):
        """Get the latest trading decisions for a stock"""
        with self.conn.cursor(cursor_factory=RealDictCursor) as cur:
            cur.execute("""
                SELECT decision, confidence, agent_name, created_at
                FROM trading_decisions
                WHERE symbol = %s
                ORDER BY created_at DESC
                LIMIT %s
                """, (symbol, limit))
            return cur.fetchall()

    def get_all_agent_decisions(self, symbol: str):
        """Get the latest decision from each agent for a stock"""
        with self.conn.cursor(cursor_factory=RealDictCursor) as cur:
            cur.execute("""
                WITH RankedDecisions AS (
                    SELECT
                        symbol,
                        decision,
                        confidence,
                        agent_name,
                        created_at,
                        ROW_NUMBER() OVER (PARTITION BY agent_name ORDER BY created_at DESC) as rn
                    FROM trading_decisions
                    WHERE symbol = %s
                )
                SELECT symbol, decision, confidence, agent_name, created_at
                FROM RankedDecisions
                WHERE rn = 1
                ORDER BY agent_name;
                """, (symbol,))
            return cur.fetchall()

    def save_audit_entry(self, symbol: str, decision_type: str, action: str, confidence: float,
                        rationale: str, compliance_status=None, risk_level=None,
                        position_size=None, blocked_trades=None):
        """Save a detailed audit entry for compliance review"""
        try:
            with self.conn.cursor() as cur:
                cur.execute("""
                    INSERT INTO audit_trail
                    (symbol, decision_type, action, confidence, rationale, compliance_status,
                     risk_level, position_size, blocked_trades)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                    """, (symbol, decision_type, action, confidence, rationale, compliance_status,
                          risk_level, position_size, blocked_trades))
                self.conn.commit()
        except Exception as e:
            print(f"Error saving audit entry: {str(e)}")
            self.conn.rollback()
            raise

    def get_audit_trail(self, symbol=None, limit=10):
        """Retrieve audit trail entries"""
        with self.conn.cursor(cursor_factory=RealDictCursor) as cur:
            if symbol:
                cur.execute("""
                    SELECT * FROM audit_trail
                    WHERE symbol = %s
                    ORDER BY timestamp DESC
                    LIMIT %s
                    """, (symbol, limit))
            else:
                cur.execute("""
                    SELECT * FROM audit_trail
                    ORDER BY timestamp DESC
                    LIMIT %s
                    """, (limit,))
            return cur.fetchall()

    def get_trading_decisions(self, symbol=None):
        """Get all trading decisions, optionally filtered by symbol"""
        with self.conn.cursor(cursor_factory=RealDictCursor) as cur:
            if symbol:
                cur.execute("""
                    SELECT * FROM trading_decisions
                    WHERE symbol = %s
                    ORDER BY created_at DESC
                    """, (symbol,))
            else:
                cur.execute("""
                    SELECT * FROM trading_decisions
                    ORDER BY created_at DESC
                    """)
            return cur.fetchall()

    def get_decisions_summary(self):
        """Get summary of all decisions"""
        with self.conn.cursor(cursor_factory=RealDictCursor) as cur:
            # Get total decisions
            cur.execute("SELECT COUNT(*) as total FROM trading_decisions")
            total = cur.fetchone()['total']

            # Get unique agents
            cur.execute("SELECT DISTINCT agent_name FROM trading_decisions")
            agents = [row['agent_name'] for row in cur.fetchall()]

            # Get unique symbols
            cur.execute("SELECT DISTINCT symbol FROM trading_decisions")
            symbols = [row['symbol'] for row in cur.fetchall()]

            # Get latest decisions
            cur.execute("""
                SELECT * FROM trading_decisions
                ORDER BY created_at DESC
                LIMIT 10
                """)
            latest = cur.fetchall()

            return {
                "total_decisions": total,
                "agents": agents,
                "symbols": symbols,
                "latest_decisions": latest
            }

    def get_all_decisions_summary(self):
        """Get comprehensive summary of all decisions (alias for compatibility)"""
        return self.get_decisions_summary()

    def get_audit_summary(self):
        """Get summary of audit trail"""
        with self.conn.cursor(cursor_factory=RealDictCursor) as cur:
            # Total entries
            cur.execute("SELECT COUNT(*) as total FROM audit_trail")
            total = cur.fetchone()['total']

            # Supervisor decisions
            cur.execute("""
                SELECT COUNT(*) as count FROM audit_trail
                WHERE decision_type = 'SUPERVISOR'
                """)
            supervisor = cur.fetchone()['count']

            # Regulatory decisions
            cur.execute("""
                SELECT COUNT(*) as count FROM audit_trail
                WHERE decision_type = 'REGULATORY'
                """)
            regulatory = cur.fetchone()['count']

            return {
                "total_entries": total,
                "supervisor_decisions": supervisor,
                "regulatory_decisions": regulatory
            }

